<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4e54c8">
    <meta name="description" content="Aplicación para realizar sorteos aleatorios de nombres con almacenamiento seguro en GitHub Gists.">
    <meta name="keywords" content="sorteo, aleatorio, nombres, random, organizador, GitHub, Gists, privado">
    <meta name="author" content="Sorteo App">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Sorteo Aleatorio de Nombres</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Librería de Confeti para la celebración -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Librería SheetJS para leer Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ffc107;
            --success-color: #198754;
            --danger-color: #dc3545;
            --github-color: #24292e;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Estilos para modo standalone (PWA) */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .pwa-install-btn {
                display: none !important;
            }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Animación suave para la lista */
        .list-item-enter {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilo personalizado para el scrollbar */
        .custom-scrollbar {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .header-bg {
            background-color: var(--primary-color);
            background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            position: relative;
            overflow: hidden;
        }

        .winner-badge {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #333;
            font-weight: bold;
        }

        .list-item {
            transition: all 0.2s ease;
        }

        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .result-item {
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .winner-item {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.05) 100%);
            border-left: 5px solid var(--accent-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
            animation: pulseWinner 2s infinite;
        }

        @keyframes pulseWinner {
            0% { box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2); }
            50% { box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4); }
            100% { box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2); }
        }

        .checkbox-custom {
            accent-color: var(--primary-color);
        }
        
        .sort-indicator {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .auto-dismiss-alert {
            animation: slideDown 0.5s ease-out, fadeOut 1s ease-in 4s forwards;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; height: 0; padding: 0; margin: 0; border: 0; overflow: hidden; }
        }

        /* Botón de instalación PWA */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

        /* Estilos GitHub */
        .github-btn {
            background-color: var(--github-color);
            border-color: var(--github-color);
            color: white;
        }
        
        .github-btn:hover {
            background-color: #000;
            border-color: #000;
            color: white;
        }
        
        .github-badge {
            background-color: var(--github-color);
            color: white;
        }
        
        .list-item-github {
            border-left: 4px solid var(--github-color);
        }
        
        .token-input-container {
            position: relative;
        }
        
        .token-preview {
            font-family: monospace;
            letter-spacing: 1px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.9em;
        }
        
        /* Modal de listas GitHub */
        .github-list-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .github-list-item:hover {
            background-color: rgba(36, 41, 46, 0.05);
            transform: translateX(5px);
        }
        
        .github-list-item.selected {
            background-color: rgba(36, 41, 46, 0.1);
            border-left: 4px solid var(--github-color);
        }
        
        /* Spinner de carga */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        /* Badge de estado de conexión */
        .status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-badge.online {
            background-color: rgba(25, 135, 84, 0.15);
            color: #198754;
            border: 1px solid rgba(25, 135, 84, 0.3);
        }
        
        .status-badge.offline {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        /* Estilos para los modales de GitHub (como en el Gestor de Asuntos Propios) */
        .modal-gist-item {
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        
        .modal-gist-item:hover {
            background-color: #f8f9fa;
            border-left-color: #4e54c8;
        }
        
        .delete-gist-btn {
            opacity: 0.5;
            transition: all 0.2s;
        }
        
        .delete-gist-btn:hover {
            opacity: 1;
            color: #dc3545 !important;
        }
        
        .deleting {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Estilo para el indicador de última actualización */
        .last-update-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 1000;
            backdrop-filter: blur(4px);
            animation: fadeInUp 0.5s ease-out;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .last-update-indicator.fade-out {
            animation: fadeOutDown 0.5s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        /* Estilos para la edición de nombres de copias */
        .gist-name-edit {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #4e54c8;
        }
        
        .gist-name-display {
            cursor: pointer;
        }
        
        .gist-name-display:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 2px 4px;
        }
        
        .edit-in-progress {
            opacity: 0.6;
        }
        
        /* Ajustes para móviles */
        @media (max-width: 768px) {
            .glass-effect {
                margin: 10px;
                border-radius: 20px;
            }
            
            .pwa-install-btn {
                bottom: 10px;
                right: 10px;
            }
            
            .btn {
                padding: 10px 15px;
            }
            
            .modal-dialog {
                margin: 10px;
            }
            
            .status-badge {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center p-3">

    <!-- Indicador de última actualización -->
    <div id="last-update-indicator" class="last-update-indicator hidden">
        <div class="d-flex align-items-center gap-1">
            <i class="fa-solid fa-clock" style="width: 12px; height: 12px;"></i>
            <span id="last-update-text"></span>
        </div>
    </div>

    <div class="glass-effect w-100 rounded-4 overflow-hidden" style="max-width: 700px;">
        
        <!-- Encabezado -->
        <div class="header-bg p-4 text-center text-white position-relative">
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-25">
                <i class="fa-solid fa-dice fa-3x position-absolute" style="top: -10px; left: -10px; transform: rotate(12deg);"></i>
                <i class="fa-solid fa-list-ol fa-3x position-absolute" style="bottom: -10px; right: -10px; transform: rotate(-12deg);"></i>
            </div>
            <h1 class="h2 fw-bold position-relative"><i class="fa-solid fa-shuffle me-2"></i>Generador Aleatorio de Sorteos</h1>
            <p class="mb-0 opacity-75 position-relative">Introduce nombres y genera un orden al azar</p>
            <div class="position-absolute top-0 end-0 mt-2 me-2">
                <span id="auth-status" class="badge bg-dark bg-opacity-50 px-3 py-2 fw-normal">Modo Local</span>
            </div>
        </div>

        <!-- Cuerpo de la App -->
        <div class="p-4">
            
            <!-- Barra de Herramientas (Importar / Exportar / GitHub) -->
            <div class="mb-4 p-3 bg-light rounded-3 border">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-2 mb-md-0">
                        <!-- Botón Importar -->
                        <div class="d-flex flex-wrap gap-2">
                            <input type="file" id="fileInput" class="d-none" accept=".xlsx, .xls, .json, .txt, .csv">
                            <button onclick="document.getElementById('fileInput').click()" 
                                class="btn btn-outline-primary btn-sm">
                                <i class="fa-solid fa-file-arrow-up me-1"></i> Importar
                            </button>
                            
                            <!-- Botón Configurar GitHub -->
                            <button class="btn btn-outline-dark btn-sm" onclick="showGitHubConfig()">
                                <i class="fa-brands fa-github me-1"></i> GitHub
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Botones Exportar y Guardar -->
                        <div class="d-flex align-items-center justify-content-end flex-wrap gap-2">
                            <span class="text-muted small fw-bold me-2">Guardar:</span>
                            <div class="btn-group" role="group">
                                <button onclick="exportList('txt')" 
                                    class="btn btn-outline-success btn-sm" title="Descargar como TXT">
                                    .txt
                                </button>
                                <button onclick="exportList('json')" 
                                    class="btn btn-outline-success btn-sm" title="Descargar como JSON">
                                    .json
                                </button>
                            </div>
                            
                            <!-- Botón Guardar en GitHub -->
                            <button id="saveToGitHubBtn" class="btn github-btn btn-sm d-none" onclick="saveGitHub()">
                                <i class="fa-brands fa-github me-1"></i> Guardar Nube
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opción para eliminar ganador -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input checkbox-custom" type="checkbox" id="eliminarGanadorCheck">
                    <label class="form-check-label" for="eliminarGanadorCheck">
                        <i class="fa-solid fa-user-minus me-1"></i> Eliminar ganador después del sorteo
                    </label>
                    <small class="d-block text-muted mt-1">
                        El nombre del ganador se eliminará automáticamente de la lista para el próximo sorteo.
                    </small>
                </div>
            </div>

            <!-- Sección de Entrada -->
            <div class="mb-4">
                <div class="input-group">
                    <input type="text" id="nameInput" 
                        class="form-control" 
                        placeholder="Escribe un nombre aquí..." autocomplete="off">
                    <button onclick="addName()" 
                        class="btn btn-primary">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <div id="duplicateAlert" class="alert alert-warning mt-2 py-2 d-none auto-dismiss-alert">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>Este nombre ya existe en la lista
                </div>
                <div class="sort-indicator mt-1">
                    <i class="fa-solid fa-sort-alpha-down me-1"></i>Los nombres se ordenan automáticamente alfabéticamente
                </div>
            </div>

            <!-- Contenedor de Listas -->
            <div id="listsContainer">
                
                <!-- Lista de Participantes (Antes del sorteo) -->
                <div id="participantsSection" class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 fw-bold text-uppercase text-secondary">
                            <i class="fa-solid fa-sort-alpha-down me-1"></i>Participantes (<span id="count">0</span>)
                        </h3>
                        <div class="d-flex align-items-center gap-2">
                            <!-- Botón Cargar desde GitHub -->
                            <button id="loadFromGitHubBtn" class="btn btn-outline-dark btn-sm d-none" onclick="loadGitHub()">
                                <i class="fa-brands fa-github me-1"></i> Cargar Nube
                            </button>
                            <button onclick="clearList()" id="clearBtn" class="btn btn-link text-danger p-0 d-none">
                                <i class="fa-solid fa-trash me-1"></i>Borrar todo
                            </button>
                        </div>
                    </div>
                    
                    <ul id="nameList" class="list-group custom-scrollbar">
                        <li id="emptyState" class="list-group-item text-center text-muted py-4">
                            <i class="fa-solid fa-list-check fa-2x mb-2 d-block"></i>
                            La lista está vacía. ¡Añade nombres o importa un archivo!
                        </li>
                    </ul>
                </div>

                <!-- Botón de Acción Principal -->
                <button onclick="sortNames()" id="sortBtn" disabled
                    class="btn btn-success w-100 py-3 fw-bold mb-4 shadow-sm">
                    <i class="fa-solid fa-play me-2"></i> ¡Sortear Orden!
                </button>

                <!-- Resultados (Ocultos inicialmente) -->
                <div id="resultSection" class="d-none border-top pt-4 mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h5 fw-bold text-success">
                            <i class="fa-solid fa-trophy me-2"></i>Resultado del Sorteo
                        </h3>
                        <button onclick="resetSort()" class="btn btn-outline-secondary btn-sm">
                            <i class="fa-solid fa-rotate-left me-1"></i> Reiniciar
                        </button>
                    </div>
                    <ul id="resultList" class="list-unstyled">
                        <!-- Los resultados irán aquí -->
                    </ul>
                </div>
            </div>
            
            <!-- Información de la PWA -->
            <div class="mt-4 pt-3 border-top text-center">
                <small class="text-muted">
                    <i class="fa-solid fa-mobile-screen me-1"></i> Instala esta app para usarla offline
                    <button class="btn btn-link btn-sm p-0 ms-1" onclick="showInstallInstructions()">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                </small>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-light p-3 text-center text-muted small border-top">
            <span id="versionInfo">v1.1.1 • Sorteo 100% aleatorio</span> • <i class="fa-solid fa-lock text-muted ms-1"></i> Local & Seguro
        </div>
    </div>

    <!-- Botón flotante para instalar PWA -->
    <button id="installButton" class="pwa-install-btn btn btn-primary rounded-circle shadow-lg d-none" 
            style="width: 60px; height: 60px;" title="Instalar aplicación" onclick="showInstallInstructions()">
        <i class="fa-solid fa-download"></i>
    </button>

    <!-- Modal de configuración de GitHub (SIMPLIFICADO como en el Gestor de Asuntos Propios) -->
    <div class="modal fade" id="githubConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">
                        <i class="fa-brands fa-github me-2"></i> Configuración GitHub
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        Para guardar en la nube, introduce tu <strong>Personal Access Token (Classic)</strong> de GitHub.
                    </div>
                    
                    <div class="mb-3">
                        <label for="githubToken" class="form-label fw-bold">Token de GitHub</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="githubToken" 
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleTokenVisibility()">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <a href="https://github.com/settings/tokens" target="_blank" class="text-decoration-none">
                                <i class="fa-solid fa-external-link me-1"></i> Generar token en GitHub
                            </a>
                        </div>
                    </div>
                    
                    <!-- Opción para cargar token desde archivo .txt -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">O carga el token desde un archivo .txt:</label>
                        <div class="d-flex align-items-center gap-2">
                            <label for="tokenFileInput" class="btn btn-outline-secondary btn-sm cursor-pointer mb-0">
                                <i class="fa-solid fa-upload me-1"></i> Seleccionar archivo
                            </label>
                            <input type="file" id="tokenFileInput" accept=".txt" class="d-none">
                            <span id="token-file-name" class="small text-muted flex-grow-1 truncate" style="max-width: 200px;">Ningún archivo seleccionado</span>
                        </div>
                    </div>
                    
                    <div id="github-msg" class="alert alert-secondary mt-3 mb-0">
                        Token no configurado.
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-dark" onclick="saveGithubToken()">
                            <i class="fa-solid fa-save me-2"></i> Validar y Guardar
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearGitHubConfig()">
                            <i class="fa-solid fa-trash me-2"></i> Eliminar configuración
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA LISTAR COPIA DE SEGURIDAD DE GITHUB (Como en el Gestor de Asuntos Propios) -->
    <div id="modal-github-list" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center z-3 hidden">
        <div class="bg-white rounded shadow-lg w-100 d-flex flex-column" style="max-width: 500px; max-height: 80vh;">
            <div class="bg-dark text-white p-3 d-flex justify-content-between align-items-center rounded-top">
                <h3 class="h6 fw-bold mb-0 d-flex align-items-center gap-2"><i class="fa-brands fa-github"></i> Copias de seguridad</h3>
                <button onclick="closeModal('modal-github-list')" class="btn btn-sm text-white p-0"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-3 bg-light border-bottom small text-secondary">Selecciona la versión que deseas restaurar:</div>
            <div class="p-0 overflow-auto flex-grow-1">
                <ul id="github-file-list" class="list-group list-group-flush"></ul>
            </div>
            <div class="p-3 bg-light rounded-bottom d-flex justify-content-end">
                <button onclick="closeModal('modal-github-list')" class="btn btn-secondary btn-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Opciones de guardado en GitHub -->
    <div id="save-options-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center z-4 hidden">
        <div class="bg-white rounded shadow-lg w-100 d-flex flex-column" style="max-width: 500px; max-height: 80vh;">
            <div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center rounded-top">
                <h3 class="h6 fw-bold mb-0 d-flex align-items-center gap-2">
                    <i class="fa-brands fa-github"></i> Opciones de guardado
                </h3>
                <button onclick="closeModal('save-options-modal')" class="btn btn-sm text-white p-0">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="p-4">
                <p class="mb-4">Se han encontrado <span id="found-backups-count">0</span> copias de seguridad existentes. ¿Qué deseas hacer?</p>
                
                <div class="vstack gap-3">
                    <button onclick="handleSaveOption('overwrite', 'save-options-modal')" 
                            class="btn btn-primary d-flex align-items-center gap-2 justify-content-start text-start">
                        <i class="fa-solid fa-save" style="width:20px"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">Sobrescribir última copia</div>
                            <small class="d-block">Actualizará la copia más reciente</small>
                        </div>
                    </button>
                    
                    <button onclick="handleSaveOption('overwrite_selected', 'save-options-modal')" 
                            class="btn btn-warning d-flex align-items-center gap-2 justify-content-start text-start">
                        <i class="fa-solid fa-pen-to-square" style="width:20px"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">Seleccionar copia para sobrescribir</div>
                            <small class="d-block">Elegirás qué copia actualizar</small>
                        </div>
                    </button>
                    
                    <button onclick="handleSaveOption('new', 'save-options-modal')" 
                            class="btn btn-success d-flex align-items-center gap-2 justify-content-start text-start">
                        <i class="fa-solid fa-plus-circle" style="width:20px"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">Crear nueva copia</div>
                            <small class="d-block">Generarás una copia nueva (seguirán existiendo las anteriores)</small>
                        </div>
                    </button>
                    
                    <button onclick="handleSaveOption('cancel', 'save-options-modal')" 
                            class="btn btn-outline-secondary mt-3">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Selección de gist para sobrescribir -->
    <div id="gist-selection-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center z-4 hidden">
        <div class="bg-white rounded shadow-lg w-100 d-flex flex-column" style="max-width: 600px; max-height: 80vh;">
            <div class="bg-warning text-dark p-3 d-flex justify-content-between align-items-center rounded-top">
                <h3 class="h6 fw-bold mb-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-pen-to-square"></i> Seleccionar copia para sobrescribir
                </h3>
                <button onclick="closeModal('gist-selection-modal')" class="btn btn-sm text-dark p-0">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="p-3 bg-light border-bottom small text-secondary">
                Selecciona la copia que deseas sobrescribir (se perderán los datos antiguos):
            </div>
            <div class="p-0 overflow-auto flex-grow-1">
                <div class="list-group list-group-flush" id="gist-selection-list"></div>
            </div>
            <div class="p-3 bg-light rounded-bottom d-flex justify-content-between align-items-center">
                <button onclick="closeModal('gist-selection-modal')" class="btn btn-secondary btn-sm">
                    Cancelar
                </button>
                <div class="small text-muted"><span id="gist-count">0</span> copias encontradas</div>
            </div>
        </div>
    </div>

    <!-- MODAL: Nombre para nueva copia -->
    <div id="new-gist-name-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center z-5 hidden">
        <div class="bg-white rounded shadow-lg w-100 d-flex flex-column" style="max-width: 500px; max-height: 80vh;">
            <div class="bg-success text-white p-3 d-flex justify-content-between align-items-center rounded-top">
                <h3 class="h6 fw-bold mb-0 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i> Nombre para la nueva copia
                </h3>
                <button onclick="closeModal('new-gist-name-modal')" class="btn btn-sm text-white p-0">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="p-4">
                <p class="mb-3">Introduce un nombre descriptivo para la nueva copia de seguridad:</p>
                <div class="mb-3">
                    <input type="text" class="form-control" id="new-gist-name-input" 
                           placeholder="Ej: Lista de alumnos 2024" autocomplete="off">
                    <div class="form-text">Este nombre te ayudará a identificar la copia más adelante.</div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button onclick="closeModal('new-gist-name-modal')" class="btn btn-secondary btn-sm">Cancelar</button>
                    <button onclick="createNewGistWithName()" class="btn btn-success btn-sm">Crear copia</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de instrucciones de instalación -->
    <div class="modal fade install-modal" id="installModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-mobile-screen me-2"></i> Instalar Aplicación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Instala esta aplicación en tu dispositivo para usarla como una app nativa, incluso sin conexión a internet.</p>
                    
                    <div class="install-steps">
                        <div class="install-step">
                            <div class="install-step-icon">
                                <i class="fa-solid fa-1"></i>
                            </div>
                            <div>
                                <strong>Abre el menú de opciones</strong>
                                <p class="mb-0 small">Toca el botón de menú (⋮) en tu navegador</p>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="install-step-icon">
                                <i class="fa-solid fa-2"></i>
                            </div>
                            <div>
                                <strong>Selecciona "Instalar app"</strong>
                                <p class="mb-0 small">Busca la opción "Instalar aplicación" o "Add to Home Screen"</p>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="install-step-icon">
                                <i class="fa-solid fa-3"></i>
                            </div>
                            <div>
                                <strong>Confirma la instalación</strong>
                                <p class="mb-0 small">Sigue las instrucciones para completar la instalación</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button id="deferredInstallBtn" class="btn btn-primary w-100 d-none" onclick="installPWA()">
                            <i class="fa-solid fa-download me-2"></i> Instalar ahora
                        </button>
                        
                        <div class="alert alert-info mt-3 small">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            Una vez instalada, la aplicación funcionará completamente offline y tendrá su propio icono en tu pantalla de inicio.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Lógica de la Aplicación ---

        // Estado global
        let names = [];
        let githubToken = localStorage.getItem('githubToken') || '';
        let currentGists = []; // Almacenar los gists actuales
        let selectedGistId = null;

        // Constantes para Gists
        const GIST_FILENAME = 'sorteo_nombres_data.json';
        const GIST_DESC = 'Sorteo Aleatorio - Lista de Nombres';

        // Referencias al DOM
        const nameInput = document.getElementById('nameInput');
        const nameList = document.getElementById('nameList');
        const countSpan = document.getElementById('count');
        const emptyState = document.getElementById('emptyState');
        const sortBtn = document.getElementById('sortBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultSection = document.getElementById('resultSection');
        const resultList = document.getElementById('resultList');
        const fileInput = document.getElementById('fileInput');
        const duplicateAlert = document.getElementById('duplicateAlert');
        const eliminarGanadorCheck = document.getElementById('eliminarGanadorCheck');
        const authStatus = document.getElementById('auth-status');
        const installButton = document.getElementById('installButton');
        const deferredInstallBtn = document.getElementById('deferredInstallBtn');
        const versionInfo = document.getElementById('versionInfo');
        const saveToGitHubBtn = document.getElementById('saveToGitHubBtn');
        const loadFromGitHubBtn = document.getElementById('loadFromGitHubBtn');
        const tokenFileInput = document.getElementById('tokenFileInput');

        // Variables para PWA
        let deferredPrompt;
        const APP_VERSION = '1.1.1';

        // Función para obtener timestamp
        function getTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Función para mostrar el indicador de última actualización
        function showLastUpdateIndicator() {
            const lastUpdate = localStorage.getItem('lastUpdate');
            if (!lastUpdate) return;
            
            try {
                const updateData = JSON.parse(lastUpdate);
                const date = new Date(updateData.timestamp);
                const formattedDate = date.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const sourceText = updateData.source === 'github' ? 'GitHub' : 'Local';
                const indicator = document.getElementById('last-update-indicator');
                const textElement = document.getElementById('last-update-text');
                
                textElement.textContent = `Última actualización: ${formattedDate} (${sourceText})`;
                indicator.classList.remove('hidden');
                
                // Auto-ocultar después de 10 segundos
                setTimeout(() => {
                    indicator.classList.add('fade-out');
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                        indicator.classList.remove('fade-out');
                    }, 500);
                }, 10000);
                
                // Cerrar al hacer clic
                indicator.onclick = () => {
                    indicator.classList.add('fade-out');
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                        indicator.classList.remove('fade-out');
                    }, 500);
                };
            } catch (e) {
                console.error('Error al procesar lastUpdate:', e);
            }
        }
        
        // Función para guardar la información de última actualización
        function saveLastUpdate(source) {
            const updateData = {
                timestamp: new Date().toISOString(),
                source: source // 'local' o 'github'
            };
            localStorage.setItem('lastUpdate', JSON.stringify(updateData));
            
            // Mostrar el indicador después de guardar
            showLastUpdateIndicator();
        }

        // Inicializar versión
        versionInfo.textContent = `v${APP_VERSION} • Sorteo 100% aleatorio`;

        // Función para ordenar nombres alfabéticamente (insensible a mayúsculas/minúsculas)
        function sortNamesAlphabetically() {
            names.sort((a, b) => {
                return a.localeCompare(b, 'es', { sensitivity: 'base' });
            });
        }

        // Escuchar tecla "Enter" en el input
        nameInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addName();
            }
        });

        // Escuchar cambio en el input de archivo
        fileInput.addEventListener('change', handleFileUpload);
        
        // Escuchar cambio en el input de archivo de token
        tokenFileInput.addEventListener('change', handleTokenFileUpload);

        // Función para manejar la subida de archivo de token
        function handleTokenFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const token = e.target.result.trim();
                document.getElementById('githubToken').value = token;
                document.getElementById('token-file-name').textContent = file.name;
                showNotification('Token cargado desde archivo', 'info');
            };
            reader.readAsText(file);
        }

        // Función para verificar si un nombre ya existe (insensible a mayúsculas/minúsculas)
        function isDuplicate(name) {
            return names.some(existingName => 
                existingName.toLowerCase().trim() === name.toLowerCase().trim()
            );
        }

        // Función para añadir nombre
        function addName() {
            const val = nameInput.value.trim();
            
            if (val) {
                // Verificar si es duplicado
                if (isDuplicate(val)) {
                    duplicateAlert.classList.remove('d-none');
                    setTimeout(() => {
                        duplicateAlert.classList.add('d-none');
                    }, 5000);
                    return;
                }
                
                addNamesToList([val]);
                nameInput.value = '';
                nameInput.focus();
            }
        }

        // Función auxiliar para añadir múltiples nombres y actualizar UI
        function addNamesToList(newNames) {
            // Filtrar vacíos y duplicados
            const validNames = newNames.filter(n => {
                const nameStr = String(n).trim();
                return nameStr && !isDuplicate(nameStr);
            });
            
            if (validNames.length > 0) {
                names = [...names, ...validNames];
                
                // Ordenar alfabéticamente
                sortNamesAlphabetically();
                
                renderList();
                
                // Si ya había resultados, los ocultamos
                if (!resultSection.classList.contains('d-none')) {
                    resetSort();
                }
                
                // Guardar en localStorage
                saveToStorage();
            }
        }

        // Función para guardar datos en localStorage
        function saveToStorage() {
            try {
                localStorage.setItem('sorteo_nombres', JSON.stringify(names));
                localStorage.setItem('sorteo_eliminar_ganador', eliminarGanadorCheck.checked);
                localStorage.setItem('sorteo_version', APP_VERSION);
            } catch (e) {
                console.log('Error guardando datos:', e);
            }
        }

        // Función para cargar datos desde localStorage
        function loadFromStorage() {
            try {
                const savedNames = localStorage.getItem('sorteo_nombres');
                const savedEliminar = localStorage.getItem('sorteo_eliminar_ganador');
                const savedVersion = localStorage.getItem('sorteo_version');
                
                if (savedNames) {
                    names = JSON.parse(savedNames);
                    sortNamesAlphabetically();
                    renderList();
                }
                
                if (savedEliminar) {
                    eliminarGanadorCheck.checked = savedEliminar === 'true';
                }
                
                // Cargar token de GitHub si existe
                if (githubToken) {
                    updateAuthStatus(true);
                    
                    // Actualizar UI del token
                    document.getElementById('githubToken').value = githubToken;
                    updateGitHubMsg('Token configurado correctamente.', 'success');
                } else {
                    updateAuthStatus(false);
                    updateGitHubMsg('Token no configurado.', 'secondary');
                }
                
                // Si hay una versión anterior, podemos hacer migraciones aquí
                if (savedVersion && savedVersion !== APP_VERSION) {
                    console.log(`Actualizando de versión ${savedVersion} a ${APP_VERSION}`);
                }
            } catch (e) {
                console.log('Error cargando datos:', e);
            }
        }

        // Función para Exportar Lista
        function exportList(type) {
            if (names.length === 0) {
                showNotification('La lista está vacía. Añade nombres antes de exportar.', 'warning');
                return;
            }

            let content = '';
            let mimeType = '';
            let extension = '';

            if (type === 'json') {
                content = JSON.stringify(names, null, 2);
                mimeType = 'application/json';
                extension = 'json';
            } else {
                // TXT (separado por comas para que sea compatible con la importación)
                content = names.join(',');
                mimeType = 'text/plain';
                extension = 'txt';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            // Crear enlace temporal y forzar descarga
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `lista_sorteo_${date}.${extension}`;
            document.body.appendChild(a);
            a.click();
            
            // Limpieza
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mostrar notificación
            showNotification(`Lista exportada correctamente (${names.length} nombres)`, 'success');
        }

        // Función para manejar la subida de archivos (MODIFICADA: ahora reemplaza la lista actual)
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileName = file.name.toLowerCase();

            reader.onload = function(e) {
                const data = e.target.result;
                let importedNames = [];

                try {
                    if (fileName.endsWith('.json')) {
                        // Lógica JSON
                        const json = JSON.parse(data);
                        if (Array.isArray(json)) {
                            // Asumimos array de strings ["Juan", "Ana"] o objetos [{name: "Juan"}]
                            importedNames = json.map(item => {
                                if (typeof item === 'object' && item !== null) {
                                    return Object.values(item)[0]; // Toma el primer valor del objeto
                                }
                                return item;
                            });
                        } else {
                            showNotification('El archivo JSON debe contener una lista (array).', 'warning');
                            return;
                        }

                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Lógica Excel (SheetJS)
                        const workbook = XLSX.read(data, {type: 'binary'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        // Convertir a array de arrays
                        const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        // Aplanar array y filtrar
                        importedNames = rows.flat();

                    } else {
                        // Lógica TXT / CSV (separado por comas o saltos de línea)
                        // Reemplazamos saltos de línea por comas para unificar el split
                        const textContent = data.replace(/(\r\n|\n|\r)/gm, ",");
                        importedNames = textContent.split(',');
                    }

                    // Limpieza final de los datos importados
                    importedNames = importedNames
                        .map(n => String(n).trim()) // Convertir a string y quitar espacios
                        .filter(n => n.length > 0); // Quitar vacíos

                    if (importedNames.length === 0) {
                        showNotification('No se encontraron nombres válidos en el archivo.', 'warning');
                        return;
                    }

                    // REEMPLAZAR la lista actual con los nombres importados
                    names = [...importedNames];
                    
                    // Filtrar duplicados
                    const uniqueNames = [];
                    names.forEach(name => {
                        if (!uniqueNames.some(n => n.toLowerCase().trim() === name.toLowerCase().trim())) {
                            uniqueNames.push(name);
                        }
                    });
                    
                    names = uniqueNames;
                    
                    // Ordenar alfabéticamente
                    sortNamesAlphabetically();
                    
                    // Actualizar UI
                    renderList();
                    saveToStorage();
                    
                    // Mostrar notificación
                    const duplicateCount = importedNames.length - uniqueNames.length;
                    if (duplicateCount > 0) {
                        showNotification(
                            `Se importaron ${uniqueNames.length} nombres (${duplicateCount} duplicados omitidos).`,
                            'info'
                        );
                    } else {
                        showNotification(`¡Se importaron ${uniqueNames.length} nombres correctamente!`, 'success');
                    }

                } catch (error) {
                    console.error(error);
                    showNotification('Error al leer el archivo. Asegúrate de que el formato sea correcto.', 'danger');
                }
                
                // Limpiar input para permitir subir el mismo archivo de nuevo si es necesario
                fileInput.value = ''; 
            };

            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }

        // Función para borrar un nombre específico
        function removeName(index) {
            names.splice(index, 1);
            
            // Ordenar alfabéticamente después de eliminar
            sortNamesAlphabetically();
            
            renderList();
            saveToStorage();
            
            if (!resultSection.classList.contains('d-none')) {
                resetSort();
            }
        }

        // Función para borrar toda la lista
        function clearList() {
            if(confirm('¿Estás seguro de que quieres borrar toda la lista?')) {
                names = [];
                renderList();
                resetSort();
                saveToStorage();
            }
        }

        // Renderizar la lista de entrada
        function renderList() {
            nameList.innerHTML = '';
            countSpan.textContent = names.length;

            if (names.length === 0) {
                nameList.appendChild(emptyState);
                sortBtn.disabled = true;
                clearBtn.classList.add('d-none');
            } else {
                sortBtn.disabled = names.length < 2; 
                clearBtn.classList.remove('d-none');

                names.forEach((name, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div class="d-flex align-items-center overflow-hidden">
                            <span class="badge bg-primary rounded-circle me-3" style="width: 28px; height: 28px; line-height: 28px;">${index + 1}</span>
                            <span class="fw-medium text-truncate">${escapeHtml(name)}</span>
                        </div>
                        <button onclick="removeName(${index})" class="btn btn-link text-muted p-0">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    nameList.appendChild(li);
                });
            }
        }

        // Función Principal: Ordenar Aleatoriamente (Algoritmo Fisher-Yates)
        function sortNames() {
            if (names.length < 2) return;

            let shuffled = [...names];
            
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            renderResults(shuffled);
            launchConfetti();
            
            // Si está activada la opción de eliminar ganador, eliminar el primer lugar
            if (eliminarGanadorCheck.checked && shuffled.length > 0) {
                const winner = shuffled[0];
                const indexToRemove = names.findIndex(name => 
                    name.toLowerCase().trim() === winner.toLowerCase().trim()
                );
                
                if (indexToRemove !== -1) {
                    names.splice(indexToRemove, 1);
                    
                    // Ordenar alfabéticamente después de eliminar
                    sortNamesAlphabetically();
                    
                    renderList();
                    saveToStorage();
                    
                    // Mostrar notificación que desaparece automáticamente después de 5 segundos
                    setTimeout(() => {
                        showNotification(`El ganador "${winner}" ha sido eliminado de la lista.`, 'info');
                    }, 500);
                }
            }
        }

        // Mostrar resultados
        function renderResults(sortedNames) {
            resultList.innerHTML = '';
            resultSection.classList.remove('d-none');
            
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            sortedNames.forEach((name, index) => {
                let isWinner = index === 0;
                
                const li = document.createElement('li');
                li.className = `result-item p-3 rounded list-item-enter ${isWinner ? 'winner-item' : ''}`;
                li.style.animationDelay = `${index * 0.1}s`;
                
                li.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="badge ${isWinner ? 'winner-badge' : 'bg-secondary'} rounded-circle me-3 d-flex align-items-center justify-content-center" 
                              style="width: 40px; height: 40px; font-size: 1.1rem;">
                            ${index + 1}
                        </span>
                        <div class="flex-grow-1">
                            <h5 class="mb-0 ${isWinner ? 'fw-bold text-warning' : 'fw-normal'}">
                                ${escapeHtml(name)} ${isWinner ? '<i class="fa-solid fa-crown ms-2"></i>' : ''}
                            </h5>
                            <small class="text-muted">Posición ${index + 1}</small>
                        </div>
                    </div>
                `;
                resultList.appendChild(li);
            });
        }

        function resetSort() {
            resultSection.classList.add('d-none');
            resultList.innerHTML = '';
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function launchConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function(min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // Función para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'warning': 'alert-warning',
                'danger': 'alert-danger',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const icon = {
                'success': 'fa-circle-check',
                'warning': 'fa-triangle-exclamation',
                'danger': 'fa-circle-exclamation',
                'info': 'fa-circle-info'
            }[type] || 'fa-circle-info';

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} auto-dismiss-alert mt-3`;
            alertDiv.innerHTML = `
                <i class="fa-solid ${icon} me-2"></i>
                ${message}
            `;
            
            const container = document.querySelector('#listsContainer');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Eliminar la alerta después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // --- Funciones para GitHub Gists (Como en el Gestor de Asuntos Propios) ---

        // Actualizar estado de autenticación
        function updateAuthStatus(isConnected) {
            const el = document.getElementById('auth-status');
            const msgEl = document.getElementById('github-msg');
            if(isConnected) {
                el.innerText = `GitHub Conectado`; 
                el.classList.replace('bg-dark', 'bg-success');
                msgEl.innerText = 'Token válido. Conectado a GitHub.'; 
                msgEl.classList.remove('alert-secondary', 'alert-danger'); 
                msgEl.classList.add('alert-success');
                
                // Mostrar botones de GitHub
                saveToGitHubBtn.classList.remove('d-none');
                loadFromGitHubBtn.classList.remove('d-none');
            } else {
                el.innerText = 'Modo Local'; 
                el.classList.replace('bg-success', 'bg-dark');
                msgEl.innerText = 'Token no configurado.'; 
                msgEl.classList.remove('alert-success', 'alert-danger'); 
                msgEl.classList.add('alert-secondary');
                
                // Ocultar botones de GitHub
                saveToGitHubBtn.classList.add('d-none');
                loadFromGitHubBtn.classList.add('d-none');
            }
        }

        // Actualizar mensaje de GitHub
        function updateGitHubMsg(message, type = 'secondary') {
            const msgEl = document.getElementById('github-msg');
            msgEl.innerHTML = message;
            msgEl.className = `alert alert-${type}`;
        }

        // Alternar visibilidad del token
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('githubToken');
            const eyeIcon = tokenInput.parentElement.querySelector('.fa-eye');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                tokenInput.type = 'password';
                eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // Guardar token de GitHub
        async function saveGithubToken() {
            const t = document.getElementById('githubToken').value.trim();
            if(!t) return showNotification("Introduce un token válido", 'warning');
            
            showNotification('Validando token...', 'info');
            
            try {
                const res = await fetch('https://api.github.com/user', { 
                    headers: { 
                        'Authorization': `token ${t}`, 
                        'Accept': 'application/vnd.github.v3+json' 
                    }
                });
                
                if(!res.ok) throw new Error("Token inválido");
                
                const user = await res.json();
                githubToken = t; 
                localStorage.setItem('githubToken', t);
                
                updateAuthStatus(true);
                updateGitHubMsg(`Token válido. Conectado como ${user.login}`, 'success');
                showNotification(`Token válido. Conectado como ${user.login}`, 'success');
                
                // Cerrar modal si está abierto
                const modal = bootstrap.Modal.getInstance(document.getElementById('githubConfigModal'));
                if (modal) modal.hide();
            } catch(e) { 
                console.error(e); 
                updateAuthStatus(false); 
                updateGitHubMsg("Token inválido. Verifica tu token.", 'danger');
                showNotification("Error: El token no funciona", 'error');
            }
        }

        // Limpiar configuración de GitHub
        function clearGitHubConfig() {
            if (confirm('¿Estás seguro de que quieres eliminar la configuración de GitHub?')) {
                localStorage.removeItem('githubToken');
                githubToken = '';
                
                // Limpiar formulario
                document.getElementById('githubToken').value = '';
                document.getElementById('token-file-name').textContent = 'Ningún archivo seleccionado';
                
                updateAuthStatus(false);
                updateGitHubMsg('Token no configurado.', 'secondary');
                
                showNotification('Configuración de GitHub eliminada.', 'info');
                
                // Cerrar modal si está abierto
                const modal = bootstrap.Modal.getInstance(document.getElementById('githubConfigModal'));
                if (modal) modal.hide();
            }
        }

        // Mostrar configuración de GitHub
        function showGitHubConfig() {
            const modal = new bootstrap.Modal(document.getElementById('githubConfigModal'));
            modal.show();
        }

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Mostrar modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // Guardar en GitHub (con opciones como en el Gestor de Asuntos Propios)
        async function saveGitHub() {
            if(!githubToken) {
                showNotification("Primero configura tu Token.", 'warning');
                showGitHubConfig();
                return;
            }
            
            if (names.length === 0) {
                showNotification('La lista está vacía. Añade nombres antes de guardar.', 'warning');
                return;
            }
            
            try {
                showNotification('Conectando con GitHub...', 'info');
                
                // Buscar gists existentes
                const listResp = await fetch('https://api.github.com/gists', { 
                    headers: {'Authorization': `token ${githubToken}`} 
                });
                
                if(!listResp.ok) throw new Error(`Error al conectar: ${listResp.status}`);
                
                const gists = await listResp.json();
                const relevantGists = gists.filter(g => 
                    (g.files && g.files[GIST_FILENAME]) || 
                    (g.description && g.description.includes('Sorteo Aleatorio'))
                );
                
                let shouldOverwrite = false;
                let existingGistId = null;
                
                if (relevantGists.length > 0) {
                    // Actualizar contador en el modal
                    document.getElementById('found-backups-count').textContent = relevantGists.length;
                    
                    // Preguntar al usuario qué hacer
                    const choice = await showSaveOptionsModal(relevantGists);
                    
                    if (choice === 'overwrite') {
                        // Ordenar por fecha más reciente
                        relevantGists.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                        existingGistId = relevantGists[0].id;
                        shouldOverwrite = true;
                    } else if (choice === 'overwrite_selected') {
                        // El usuario seleccionará uno específico
                        await showGistSelectionModal(relevantGists, 'overwrite');
                        return; // La función modal manejará el proceso
                    } else if (choice === 'new') {
                        // Mostrar modal para nombre de nueva copia
                        showModal('new-gist-name-modal');
                        return;
                    } else {
                        // Usuario canceló
                        return;
                    }
                } else {
                    // No hay copias existentes, mostrar modal para nombre de nueva copia
                    showModal('new-gist-name-modal');
                    return;
                }
                
                const content = JSON.stringify(names, null, 2);
                const timestamp = getTimestamp();
                
                if (shouldOverwrite && existingGistId) {
                    // Sobrescribir gist existente
                    const body = { 
                        description: `${GIST_DESC} - ${timestamp} (Sobrescrito)`, 
                        files: { [GIST_FILENAME]: { content: content } } 
                    };
                    
                    const resp = await fetch(`https://api.github.com/gists/${existingGistId}`, { 
                        method: 'PATCH', 
                        headers: {'Authorization': `token ${githubToken}`}, 
                        body: JSON.stringify(body) 
                    });
                    
                    if(!resp.ok) throw new Error(`Error al sobrescribir: ${resp.status}`);
                    showNotification('¡Datos sobrescritos en GitHub!', 'success');
                    saveLastUpdate('github');
                }
                
            } catch (e) { 
                console.error(e); 
                showNotification('Error en el guardado: ' + e.message, 'error'); 
            }
        }

        // Función para crear nuevo gist con nombre personalizado - CORREGIDA
        async function createNewGistWithName() {
            const gistNameInput = document.getElementById('new-gist-name-input');
            let gistName = gistNameInput.value.trim();
            
            if (!gistName) {
                showNotification('Por favor, introduce un nombre para la copia.', 'warning');
                gistNameInput.focus();
                return;
            }
            
            // Limpiar el nombre para evitar problemas con GitHub
            // Remover caracteres especiales que puedan causar problemas
            gistName = gistName.replace(/[^\w\sáéíóúÁÉÍÓÚñÑüÜ.,;:()\[\]{}¡!¿?\-_]/g, '');
            
            // Asegurarse de que el nombre no esté vacío después de la limpieza
            if (!gistName.trim()) {
                showNotification('El nombre contiene caracteres no válidos. Por favor, usa solo letras, números y espacios.', 'warning');
                return;
            }
            
            // Limitar la longitud del nombre
            if (gistName.length > 100) {
                gistName = gistName.substring(0, 100);
                showNotification('El nombre se ha truncado a 100 caracteres.', 'info');
            }
            
            try {
                showNotification('Creando nueva copia...', 'info');
                const content = JSON.stringify(names, null, 2);
                
                // Crear un objeto seguro para la petición
                const body = { 
                    description: gistName, 
                    public: false, 
                    files: { 
                        [GIST_FILENAME]: { 
                            content: content 
                        } 
                    } 
                };
                
                // Usar fetch con manejo de errores mejorado
                const resp = await fetch('https://api.github.com/gists', { 
                    method: 'POST', 
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    }, 
                    body: JSON.stringify(body) 
                });
                
                if(!resp.ok) {
                    // Intentar obtener más información del error
                    let errorMsg = `Error ${resp.status}: ${resp.statusText}`;
                    try {
                        const errorData = await resp.json();
                        if (errorData.message) {
                            errorMsg = errorData.message;
                        }
                    } catch (parseError) {
                        // Si no podemos parsear la respuesta, usar el mensaje por defecto
                    }
                    throw new Error(errorMsg);
                }
                
                const result = await resp.json();
                
                // Limpiar input y cerrar modal
                gistNameInput.value = '';
                closeModal('new-gist-name-modal');
                
                showNotification('¡Nueva copia creada en GitHub!', 'success');
                saveLastUpdate('github');
                
                // AGREGAR EL NUEVO GIST A LA LISTA ACTUAL Y ACTUALIZAR LA UI
                currentGists.push(result);
                // Ordenar por fecha más reciente primero
                currentGists.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                
                // Si el modal de listas está abierto, actualizar la lista
                const githubListModal = document.getElementById('modal-github-list');
                if (!githubListModal.classList.contains('hidden')) {
                    renderGistList(currentGists);
                }
                
            } catch (e) { 
                console.error('Error al crear gist:', e); 
                showNotification('Error al crear la copia: ' + e.message, 'error'); 
            }
        }

        // Modal para opciones de guardado
        function showSaveOptionsModal(gists) {
            return new Promise((resolve) => {
                const modalId = 'save-options-modal';
                const modal = document.getElementById(modalId);
                
                // Actualizar contador
                document.getElementById('found-backups-count').textContent = gists.length;
                
                // Configurar resolución
                window.handleSaveOption = function(option, modalId) {
                    document.getElementById(modalId).classList.add('hidden');
                    resolve(option);
                };
                
                // Mostrar modal
                modal.classList.remove('hidden');
            });
        }

        // Modal para seleccionar gist a sobrescribir
        function showGistSelectionModal(gists, action) {
            return new Promise((resolve) => {
                const modalId = 'gist-selection-modal';
                const modal = document.getElementById(modalId);
                
                // Ordenar por fecha (más reciente primero)
                gists.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                
                // Actualizar contador
                document.getElementById('gist-count').textContent = gists.length;
                
                // Llenar la lista
                const listContainer = document.getElementById('gist-selection-list');
                listContainer.innerHTML = '';
                
                gists.forEach((gist, index) => {
                    const date = new Date(gist.updated_at).toLocaleString('es-ES');
                    const desc = gist.description || '(Sin descripción)';
                    const isMostRecent = index === 0;
                    
                    const item = document.createElement('div');
                    item.className = `list-group-item list-group-item-action p-3 ${isMostRecent ? 'border-start border-3 border-warning' : ''}`;
                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-3" type="radio" name="selectedGist" id="gist-${gist.id}" value="${gist.id}">
                            <label class="flex-grow-1" for="gist-${gist.id}" style="cursor: pointer;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1 me-3">
                                        <div class="fw-bold text-dark">${desc}</div>
                                        <div class="small text-secondary mt-1 d-flex align-items-center gap-2">
                                            <i class="fa-solid fa-clock" style="width:12px"></i> ${date}
                                            ${isMostRecent ? '<span class="badge bg-warning text-dark">Más reciente</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    `;
                    listContainer.appendChild(item);
                    
                    // Configurar evento de clic
                    item.addEventListener('click', (e) => {
                        if (!e.target.matches('input[type="radio"]')) {
                            const radio = item.querySelector('input[type="radio"]');
                            radio.checked = true;
                            selectedGistId = gist.id;
                        }
                    });
                });
                
                // Añadir botón de confirmar
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-warning w-100 rounded-0 border-0';
                confirmBtn.innerHTML = '<i class="fa-solid fa-save me-2"></i> Sobrescribir copia seleccionada';
                confirmBtn.onclick = async () => {
                    if (!selectedGistId) {
                        showNotification('Por favor, selecciona una copia para sobrescribir', 'warning');
                        return;
                    }
                    
                    modal.classList.add('hidden');
                    
                    // Proceder a sobrescribir
                    try {
                        showNotification('Sobrescribiendo copia...', 'info');
                        const content = JSON.stringify(names, null, 2);
                        const timestamp = getTimestamp();
                        
                        const body = { 
                            description: `${GIST_DESC} - ${timestamp} (Sobrescrito)`, 
                            files: { [GIST_FILENAME]: { content: content } } 
                        };
                        
                        const resp = await fetch(`https://api.github.com/gists/${selectedGistId}`, { 
                            method: 'PATCH', 
                            headers: {'Authorization': `token ${githubToken}`}, 
                            body: JSON.stringify(body) 
                        });
                        
                        if(!resp.ok) throw new Error(`Error al sobrescribir: ${resp.status}`);
                        showNotification('¡Copia sobrescrita en GitHub!', 'success');
                        saveLastUpdate('github');
                        
                        // Actualizar el gist en currentGists si existe
                        const gistIndex = currentGists.findIndex(g => g.id === selectedGistId);
                        if (gistIndex !== -1) {
                            currentGists[gistIndex].description = `${GIST_DESC} - ${timestamp} (Sobrescrito)`;
                            currentGists[gistIndex].updated_at = new Date().toISOString();
                            
                            // Si el modal de listas está abierto, actualizar la lista
                            const githubListModal = document.getElementById('modal-github-list');
                            if (!githubListModal.classList.contains('hidden')) {
                                renderGistList(currentGists);
                            }
                        }
                    } catch (e) { 
                        console.error(e); 
                        showNotification('Error al sobrescribir: ' + e.message, 'error'); 
                    }
                };
                
                listContainer.appendChild(confirmBtn);
                
                // Mostrar modal
                modal.classList.remove('hidden');
            });
        }

        // Cargar desde GitHub
        async function loadGitHub() {
            if(!githubToken) {
                showNotification("Configura tu Token primero.", 'warning');
                showGitHubConfig();
                return;
            }
            
            try {
                showNotification('Consultando GitHub...', 'info');
                const listResp = await fetch('https://api.github.com/gists', { 
                    headers: {'Authorization': `token ${githubToken}`} 
                });
                
                if(!listResp.ok) throw new Error('Error al conectar con GitHub.');
                
                const gists = await listResp.json();
                const relevantGists = gists.filter(g => 
                    (g.files && g.files[GIST_FILENAME]) || 
                    (g.description && g.description.includes('Sorteo Aleatorio'))
                );
                
                if (relevantGists.length === 0) throw new Error('No se encontraron copias.');
                
                currentGists = relevantGists;
                renderGistList(relevantGists);
                showModal('modal-github-list');
            } catch (e) { 
                console.error(e); 
                showNotification(e.message, 'error'); 
            }
        }

        // Renderizar lista de Gists con funcionalidad de edición
        function renderGistList(gists) {
            const container = document.getElementById('github-file-list'); 
            container.innerHTML = '';
            
            if (gists.length === 0) {
                container.innerHTML = `
                    <li class="list-group-item text-center text-muted py-4">
                        <i class="fa-solid fa-folder-xmark me-2"></i>
                        <div>No se encontraron copias de seguridad</div>
                    </li>
                `;
                return;
            }
            
            // Ordenar por fecha (más reciente primero)
            gists.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            
            gists.forEach((gist, index) => {
                const date = new Date(gist.updated_at).toLocaleString('es-ES');
                const desc = gist.description || '(Sin descripción)';
                const gistId = gist.id;
                const isMostRecent = index === 0;
                
                const li = document.createElement('li');
                li.id = `gist-item-${gistId}`;
                li.className = 'list-group-item modal-gist-item p-3';
                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-3" style="cursor: pointer;" onclick="loadSpecificGist('${gistId}')">
                            <div class="fw-bold text-dark gist-name-display" onclick="event.stopPropagation(); toggleGistNameEdit('${gistId}', this)">
                                ${desc}
                            </div>
                            <div class="small text-secondary mt-1 d-flex align-items-center gap-2">
                                <i class="fa-solid fa-clock" style="width:12px"></i> ${date} 
                                ${isMostRecent ? '<span class="badge bg-warning text-dark">Más reciente</span>' : ''}
                                <span class="badge bg-light text-secondary border">ID: ${gistId.substr(0,7)}...</span>
                            </div>
                            <div class="gist-name-edit mt-2" id="gist-edit-${gistId}">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="gist-edit-input-${gistId}" value="${desc}" placeholder="Nuevo nombre para la copia">
                                    <button class="btn btn-outline-primary" type="button" onclick="saveGistName('${gistId}')">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="cancelGistNameEdit('${gistId}')">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1">Presiona Enter para guardar, Esc para cancelar</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button onclick="loadSpecificGist('${gistId}')" 
                                    class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1">
                                <i class="fa-solid fa-download" style="width:14px"></i>
                                <span class="d-none d-md-inline">Restaurar</span>
                            </button>
                            <button onclick="toggleGistNameEdit('${gistId}')" 
                                    class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
                                <i class="fa-solid fa-pen" style="width:14px"></i>
                                <span class="d-none d-md-inline">Editar</span>
                            </button>
                            <button onclick="deleteGist('${gistId}', ${index})" 
                                    class="btn btn-sm btn-outline-danger delete-gist-btn d-flex align-items-center gap-1">
                                <i class="fa-solid fa-trash" style="width:14px"></i>
                                <span class="d-none d-md-inline">Eliminar</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(li);
            });
        }

        // Mostrar/ocultar editor de nombre de gist
        function toggleGistNameEdit(gistId, displayElement = null) {
            const editDiv = document.getElementById(`gist-edit-${gistId}`);
            const input = document.getElementById(`gist-edit-input-${gistId}`);
            
            if (editDiv.style.display === 'block') {
                // Si ya está visible, cancelar edición
                cancelGistNameEdit(gistId);
            } else {
                // Mostrar editor
                editDiv.style.display = 'block';
                if (displayElement) {
                    displayElement.style.display = 'none';
                } else {
                    // Buscar el elemento de display
                    const displayEl = document.querySelector(`#gist-item-${gistId} .gist-name-display`);
                    if (displayEl) displayEl.style.display = 'none';
                }
                
                input.focus();
                input.select();
                
                // Configurar eventos de teclado
                input.onkeydown = function(e) {
                    if (e.key === 'Enter') {
                        saveGistName(gistId);
                    } else if (e.key === 'Escape') {
                        cancelGistNameEdit(gistId);
                    }
                };
            }
        }

        // Cancelar edición de nombre de gist
        function cancelGistNameEdit(gistId) {
            const editDiv = document.getElementById(`gist-edit-${gistId}`);
            const displayEl = document.querySelector(`#gist-item-${gistId} .gist-name-display`);
            
            editDiv.style.display = 'none';
            if (displayEl) displayEl.style.display = 'block';
        }

        // Guardar nuevo nombre para gist - CORREGIDA
        async function saveGistName(gistId) {
            const input = document.getElementById(`gist-edit-input-${gistId}`);
            let newName = input.value.trim();
            
            if (!newName) {
                showNotification('El nombre no puede estar vacío', 'warning');
                return;
            }
            
            // Limpiar el nombre para evitar problemas con GitHub
            newName = newName.replace(/[^\w\sáéíóúÁÉÍÓÚñÑüÜ.,;:()\[\]{}¡!¿?\-_]/g, '');
            
            if (!newName.trim()) {
                showNotification('El nombre contiene caracteres no válidos. Por favor, usa solo letras, números y espacios.', 'warning');
                return;
            }
            
            if(!githubToken) {
                showNotification('Error: Token no configurado', 'error');
                return;
            }
            
            try {
                // Obtener el gist actual
                const gistResp = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                
                if(!gistResp.ok) throw new Error('Error al obtener el gist');
                
                const gist = await gistResp.json();
                
                // Actualizar solo la descripción
                const body = {
                    description: newName,
                    files: gist.files // Mantener los mismos archivos
                };
                
                const updateResp = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                
                if(!updateResp.ok) {
                    let errorMsg = `Error ${updateResp.status}: ${updateResp.statusText}`;
                    try {
                        const errorData = await updateResp.json();
                        if (errorData.message) {
                            errorMsg = errorData.message;
                        }
                    } catch (parseError) {}
                    throw new Error(errorMsg);
                }
                
                // Actualizar la UI
                const displayEl = document.querySelector(`#gist-item-${gistId} .gist-name-display`);
                if (displayEl) {
                    displayEl.textContent = newName;
                }
                
                // Ocultar editor
                cancelGistNameEdit(gistId);
                
                // Actualizar en currentGists
                const gistIndex = currentGists.findIndex(g => g.id === gistId);
                if (gistIndex !== -1) {
                    currentGists[gistIndex].description = newName;
                    currentGists[gistIndex].updated_at = new Date().toISOString();
                }
                
                showNotification('Nombre actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error al actualizar nombre:', error);
                showNotification('Error al actualizar el nombre: ' + error.message, 'error');
            }
        }

        // Cargar un Gist específico (MODIFICADA: ahora siempre reemplaza la lista)
        async function loadSpecificGist(gistId) {
            closeModal('modal-github-list');
            showNotification('Descargando...', 'info');
            
            try {
                const gistResp = await fetch(`https://api.github.com/gists/${gistId}`, { 
                    headers: {'Authorization': `token ${githubToken}`} 
                });
                
                if(!gistResp.ok) throw new Error('Error al descargar.');
                
                const fullGist = await gistResp.json();
                const targetFile = fullGist.files[GIST_FILENAME];
                
                if (!targetFile) throw new Error(`Archivo ${GIST_FILENAME} no encontrado.`);
                
                const data = JSON.parse(targetFile.content);
                
                if(Array.isArray(data) && data.length > 0) {
                    // SIEMPRE REEMPLAZAR la lista actual
                    names = [...data];
                    sortNamesAlphabetically();
                    renderList();
                    saveToStorage();
                    showNotification('¡Lista restaurada correctamente!', 'success');
                    
                    // Guardar información de última actualización
                    saveLastUpdate('github');
                } else {
                    throw new Error('Formato incorrecto o lista vacía.');
                }
            } catch (e) { 
                console.error(e); 
                showNotification(e.message, 'error'); 
            }
        }

        // Eliminar un Gist
        async function deleteGist(gistId, index) {
            // Obtener el elemento DOM correspondiente
            const gistElement = document.getElementById(`gist-item-${gistId}`);
            if (!gistElement) return;
            
            const gistDescription = currentGists[index]?.description || '(Sin descripción)';
            
            if (!confirm(`¿Estás seguro de que quieres eliminar permanentemente esta copia de seguridad?\n\n"${gistDescription}"\n\nEsta acción no se puede deshacer.`)) {
                return;
            }
            
            if(!githubToken) {
                showNotification('Error: Token no configurado', 'error');
                return;
            }
            
            // Deshabilitar el elemento mientras se procesa
            gistElement.classList.add('deleting');
            const buttons = gistElement.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            // Cambiar el texto del botón de eliminar
            const deleteBtn = gistElement.querySelector('.delete-gist-btn');
            if (deleteBtn) {
                deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Eliminando...';
            }
            
            try {
                showNotification('Eliminando copia de seguridad...', 'info');
                
                const deleteResp = await fetch(`https://api.github.com/gists/${gistId}`, { 
                    method: 'DELETE', 
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if(!deleteResp.ok) {
                    if (deleteResp.status === 404) {
                        throw new Error('La copia de seguridad no existe o ya fue eliminada.');
                    } else if (deleteResp.status === 403) {
                        throw new Error('Permiso denegado. Verifica que tu token tenga permisos para eliminar gists.');
                    } else {
                        throw new Error(`Error al eliminar: ${deleteResp.status} ${deleteResp.statusText}`);
                    }
                }
                
                // 1. Eliminar el gist del array currentGists
                currentGists.splice(index, 1);
                
                // 2. Eliminar el elemento del DOM
                gistElement.remove();
                
                // 3. Verificar si quedan elementos en la lista
                const container = document.getElementById('github-file-list');
                if (currentGists.length === 0) {
                    container.innerHTML = `
                        <li class="list-group-item text-center text-muted py-4">
                            <i class="fa-solid fa-folder-xmark me-2"></i>
                            <div>No se encontraron copias de seguridad</div>
                        </li>
                    `;
                }
                
                showNotification('¡Copia de seguridad eliminada correctamente!', 'success');
                
            } catch (e) {
                console.error(e);
                showNotification(`Error: ${e.message}`, 'error');
                
                // Restaurar el elemento si hay error
                gistElement.classList.remove('deleting');
                buttons.forEach(btn => btn.disabled = false);
                if (deleteBtn) {
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash me-1"></i><span class="d-none d-md-inline"> Eliminar</span>';
                }
            }
        }

        // --- Funcionalidades PWA ---

        // Mostrar instrucciones de instalación
        function showInstallInstructions() {
            const modal = new bootstrap.Modal(document.getElementById('installModal'));
            modal.show();
        }

        // Instalar PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario aceptó la instalación');
                        showNotification('¡Aplicación instalada correctamente!', 'success');
                        installButton.classList.add('d-none');
                        deferredInstallBtn.classList.add('d-none');
                    } else {
                        console.log('Usuario rechazó la instalación');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Detectar cambios en la conexión
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const statusElement = document.getElementById('auth-status');
            
            if (!githubToken) {
                return; // Mantener el estado actual (Modo Local)
            }
            
            if (isOnline) {
                statusElement.classList.remove('bg-danger');
                statusElement.classList.add('bg-success');
            } else {
                statusElement.classList.remove('bg-success');
                statusElement.classList.add('bg-danger');
                statusElement.innerHTML = '<i class="fa-solid fa-wifi-slash me-1"></i> Sin conexión';
            }
        }

        // Registrar Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registrado con éxito:', registration.scope);
                        })
                        .catch(error => {
                            console.log('Error al registrar ServiceWorker:', error);
                        });
                });
            }
        }

        // Inicializar la aplicación
        function initApp() {
            // Cargar datos guardados
            loadFromStorage();
            
            // Mostrar indicador de última actualización al iniciar
            showLastUpdateIndicator();
            
            // Configurar eventos de conexión
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
            
            // Registrar Service Worker
            registerServiceWorker();
            
            // Evento para instalación de PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar botón de instalación si no está ya instalado
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    installButton.classList.remove('d-none');
                    deferredInstallBtn.classList.remove('d-none');
                }
            });
            
            // Ocultar botón de instalación si ya está instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
                installButton.classList.add('d-none');
            }
            
            // Evento cuando la app se instala
            window.addEventListener('appinstalled', () => {
                console.log('Aplicación instalada');
                installButton.classList.add('d-none');
                deferredInstallBtn.classList.add('d-none');
                deferredPrompt = null;
            });
            
            // Guardar automáticamente cuando cambia el checkbox
            eliminarGanadorCheck.addEventListener('change', saveToStorage);
            
            // Configurar tecla Enter en el modal de nombre de nueva copia
            document.getElementById('new-gist-name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createNewGistWithName();
                }
            });
        }

        // Inicializar cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>