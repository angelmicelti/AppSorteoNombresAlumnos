<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4e54c8">
    <meta name="description" content="Aplicación para realizar sorteos aleatorios de nombres. Ordena alfabéticamente y elimina ganadores automáticamente.">
    <meta name="keywords" content="sorteo, aleatorio, nombres, random, organizador">
    <meta name="author" content="Sorteo App">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Sorteo Aleatorio de Nombres</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Librería de Confeti para la celebración -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Librería SheetJS para leer Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ffc107;
            --success-color: #198754;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Estilos para modo standalone (PWA) */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .pwa-install-btn {
                display: none !important;
            }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Animación suave para la lista */
        .list-item-enter {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilo personalizado para el scrollbar */
        .custom-scrollbar {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .header-bg {
            background-color: var(--primary-color);
            background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            position: relative;
            overflow: hidden;
        }

        .winner-badge {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #333;
            font-weight: bold;
        }

        .list-item {
            transition: all 0.2s ease;
        }

        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .result-item {
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .winner-item {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.05) 100%);
            border-left: 5px solid var(--accent-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
            animation: pulseWinner 2s infinite;
        }

        @keyframes pulseWinner {
            0% { box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2); }
            50% { box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4); }
            100% { box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2); }
        }

        .checkbox-custom {
            accent-color: var(--primary-color);
        }
        
        .sort-indicator {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .auto-dismiss-alert {
            animation: slideDown 0.5s ease-out, fadeOut 1s ease-in 4s forwards;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; height: 0; padding: 0; margin: 0; border: 0; overflow: hidden; }
        }

        /* Botón de instalación PWA */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

        /* Modal de instalación */
        .install-modal .modal-content {
            border-radius: 15px;
            overflow: hidden;
        }

        .install-modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .install-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .install-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .install-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--danger-color);
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 2000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-indicator.show {
            transform: translateY(0);
        }

        /* Touch feedback */
        .btn:active, button:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }

        /* Ajustes para móviles */
        @media (max-width: 768px) {
            .glass-effect {
                margin: 10px;
                border-radius: 20px;
            }
            
            .pwa-install-btn {
                bottom: 10px;
                right: 10px;
            }
            
            .btn {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center p-3">

    <!-- Indicador de modo offline -->
    <div id="offlineIndicator" class="offline-indicator">
        <i class="fa-solid fa-wifi-slash me-2"></i> Estás trabajando sin conexión
    </div>

    <div class="glass-effect w-100 rounded-4 overflow-hidden" style="max-width: 600px;">
        
        <!-- Encabezado -->
        <div class="header-bg p-4 text-center text-white position-relative">
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-25">
                <i class="fa-solid fa-dice fa-3x position-absolute" style="top: -10px; left: -10px; transform: rotate(12deg);"></i>
                <i class="fa-solid fa-list-ol fa-3x position-absolute" style="bottom: -10px; right: -10px; transform: rotate(-12deg);"></i>
            </div>
            <h1 class="h2 fw-bold position-relative"><i class="fa-solid fa-shuffle me-2"></i>Organizador Aleatorio</h1>
            <p class="mb-0 opacity-75 position-relative">Introduce nombres y genera un orden al azar</p>
            <div class="position-absolute top-0 end-0 mt-2 me-2">
                <span id="appStatus" class="badge bg-success bg-opacity-75">
                    <i class="fa-solid fa-circle me-1" style="font-size: 0.6rem;"></i> Online
                </span>
            </div>
        </div>

        <!-- Cuerpo de la App -->
        <div class="p-4">
            
            <!-- Barra de Herramientas (Importar / Exportar) -->
            <div class="mb-4 p-3 bg-light rounded-3 border">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-2 mb-md-0">
                        <!-- Botón Importar -->
                        <div>
                            <input type="file" id="fileInput" class="d-none" accept=".xlsx, .xls, .json, .txt, .csv">
                            <button onclick="document.getElementById('fileInput').click()" 
                                class="btn btn-outline-primary btn-sm">
                                <i class="fa-solid fa-file-arrow-up me-1"></i> Importar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Botones Exportar -->
                        <div class="d-flex align-items-center justify-content-end">
                            <span class="text-muted small fw-bold me-2">Guardar:</span>
                            <div class="btn-group" role="group">
                                <button onclick="exportList('txt')" 
                                    class="btn btn-outline-success btn-sm" title="Descargar como TXT">
                                    .txt
                                </button>
                                <button onclick="exportList('json')" 
                                    class="btn btn-outline-success btn-sm" title="Descargar como JSON">
                                    .json
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opción para eliminar ganador -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input checkbox-custom" type="checkbox" id="eliminarGanadorCheck">
                    <label class="form-check-label" for="eliminarGanadorCheck">
                        <i class="fa-solid fa-user-minus me-1"></i> Eliminar ganador después del sorteo
                    </label>
                    <small class="d-block text-muted mt-1">
                        El nombre del ganador se eliminará automáticamente de la lista para el próximo sorteo.
                    </small>
                </div>
            </div>

            <!-- Sección de Entrada -->
            <div class="mb-4">
                <div class="input-group">
                    <input type="text" id="nameInput" 
                        class="form-control" 
                        placeholder="Escribe un nombre aquí..." autocomplete="off">
                    <button onclick="addName()" 
                        class="btn btn-primary">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <div id="duplicateAlert" class="alert alert-warning mt-2 py-2 d-none auto-dismiss-alert">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>Este nombre ya existe en la lista
                </div>
                <div class="sort-indicator mt-1">
                    <i class="fa-solid fa-sort-alpha-down me-1"></i>Los nombres se ordenan automáticamente alfabéticamente
                </div>
            </div>

            <!-- Contenedor de Listas -->
            <div id="listsContainer">
                
                <!-- Lista de Participantes (Antes del sorteo) -->
                <div id="participantsSection" class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h6 fw-bold text-uppercase text-secondary">
                            <i class="fa-solid fa-sort-alpha-down me-1"></i>Participantes (<span id="count">0</span>)
                        </h3>
                        <button onclick="clearList()" id="clearBtn" class="btn btn-link text-danger p-0 d-none">
                            <i class="fa-solid fa-trash me-1"></i>Borrar todo
                        </button>
                    </div>
                    
                    <ul id="nameList" class="list-group custom-scrollbar">
                        <li id="emptyState" class="list-group-item text-center text-muted py-4">
                            <i class="fa-solid fa-list-check fa-2x mb-2 d-block"></i>
                            La lista está vacía. ¡Añade nombres o importa un archivo!
                        </li>
                    </ul>
                </div>

                <!-- Botón de Acción Principal -->
                <button onclick="sortNames()" id="sortBtn" disabled
                    class="btn btn-success w-100 py-3 fw-bold mb-4 shadow-sm">
                    <i class="fa-solid fa-play me-2"></i> ¡Sortear Orden!
                </button>

                <!-- Resultados (Ocultos inicialmente) -->
                <div id="resultSection" class="d-none border-top pt-4 mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h5 fw-bold text-success">
                            <i class="fa-solid fa-trophy me-2"></i>Resultado del Sorteo
                        </h3>
                        <button onclick="resetSort()" class="btn btn-outline-secondary btn-sm">
                            <i class="fa-solid fa-rotate-left me-1"></i> Reiniciar
                        </button>
                    </div>
                    <ul id="resultList" class="list-unstyled">
                        <!-- Los resultados irán aquí -->
                    </ul>
                </div>
            </div>
            
            <!-- Información de la PWA -->
            <div class="mt-4 pt-3 border-top text-center">
                <small class="text-muted">
                    <i class="fa-solid fa-mobile-screen me-1"></i> Instala esta app para usarla offline
                    <button class="btn btn-link btn-sm p-0 ms-1" onclick="showInstallInstructions()">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                </small>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-light p-3 text-center text-muted small border-top">
            <span id="versionInfo">v1.0.0 • Sorteo 100% aleatorio</span> • <i class="fa-solid fa-lock text-muted ms-1"></i> Local & Seguro
        </div>
    </div>

    <!-- Botón flotante para instalar PWA -->
    <button id="installButton" class="pwa-install-btn btn btn-primary rounded-circle shadow-lg d-none" 
            style="width: 60px; height: 60px;" title="Instalar aplicación" onclick="showInstallInstructions()">
        <i class="fa-solid fa-download"></i>
    </button>

    <!-- Modal de instrucciones de instalación -->
    <div class="modal fade install-modal" id="installModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header install-modal-header">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-mobile-screen me-2"></i> Instalar Aplicación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Instala esta aplicación en tu dispositivo para usarla como una app nativa, incluso sin conexión a internet.</p>
                    
                    <div class="install-steps">
                        <div class="install-step">
                            <div class="install-step-icon">
                                <i class="fa-solid fa-1"></i>
                            </div>
                            <div>
                                <strong>Abre el menú de opciones</strong>
                                <p class="mb-0 small">Toca el botón de menú (⋮) en tu navegador</p>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="install-step-icon">
                                <i class="fa-solid fa-2"></i>
                            </div>
                            <div>
                                <strong>Selecciona "Instalar app"</strong>
                                <p class="mb-0 small">Busca la opción "Instalar aplicación" o "Add to Home Screen"</p>
                            </div>
                        </div>
                        
                        <div class="install-step">
                            <div class="install-step-icon">
                                <i class="fa-solid fa-3"></i>
                            </div>
                            <div>
                                <strong>Confirma la instalación</strong>
                                <p class="mb-0 small">Sigue las instrucciones para completar la instalación</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button id="deferredInstallBtn" class="btn btn-primary w-100 d-none" onclick="installPWA()">
                            <i class="fa-solid fa-download me-2"></i> Instalar ahora
                        </button>
                        
                        <div class="alert alert-info mt-3 small">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            Una vez instalada, la aplicación funcionará completamente offline y tendrá su propio icono en tu pantalla de inicio.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Lógica de la Aplicación ---

        // Estado global
        let names = [];

        // Referencias al DOM
        const nameInput = document.getElementById('nameInput');
        const nameList = document.getElementById('nameList');
        const countSpan = document.getElementById('count');
        const emptyState = document.getElementById('emptyState');
        const sortBtn = document.getElementById('sortBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultSection = document.getElementById('resultSection');
        const resultList = document.getElementById('resultList');
        const fileInput = document.getElementById('fileInput');
        const duplicateAlert = document.getElementById('duplicateAlert');
        const eliminarGanadorCheck = document.getElementById('eliminarGanadorCheck');
        const offlineIndicator = document.getElementById('offlineIndicator');
        const appStatus = document.getElementById('appStatus');
        const installButton = document.getElementById('installButton');
        const deferredInstallBtn = document.getElementById('deferredInstallBtn');
        const versionInfo = document.getElementById('versionInfo');

        // Variables para PWA
        let deferredPrompt;
        const APP_VERSION = '1.0.1';

        // Inicializar versión
        versionInfo.textContent = `v${APP_VERSION} • Sorteo 100% aleatorio`;

        // Función para ordenar nombres alfabéticamente (insensible a mayúsculas/minúsculas)
        function sortNamesAlphabetically() {
            names.sort((a, b) => {
                return a.localeCompare(b, 'es', { sensitivity: 'base' });
            });
        }

        // Escuchar tecla "Enter" en el input
        nameInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addName();
            }
        });

        // Escuchar cambio en el input de archivo
        fileInput.addEventListener('change', handleFileUpload);

        // Función para verificar si un nombre ya existe (insensible a mayúsculas/minúsculas)
        function isDuplicate(name) {
            return names.some(existingName => 
                existingName.toLowerCase().trim() === name.toLowerCase().trim()
            );
        }

        // Función para añadir nombre
        function addName() {
            const val = nameInput.value.trim();
            
            if (val) {
                // Verificar si es duplicado
                if (isDuplicate(val)) {
                    duplicateAlert.classList.remove('d-none');
                    setTimeout(() => {
                        duplicateAlert.classList.add('d-none');
                    }, 5000);
                    return;
                }
                
                addNamesToList([val]);
                nameInput.value = '';
                nameInput.focus();
            }
        }

        // Función auxiliar para añadir múltiples nombres y actualizar UI
        function addNamesToList(newNames) {
            // Filtrar vacíos y duplicados
            const validNames = newNames.filter(n => {
                const nameStr = String(n).trim();
                return nameStr && !isDuplicate(nameStr);
            });
            
            if (validNames.length > 0) {
                names = [...names, ...validNames];
                
                // Ordenar alfabéticamente
                sortNamesAlphabetically();
                
                renderList();
                
                // Si ya había resultados, los ocultamos
                if (!resultSection.classList.contains('d-none')) {
                    resetSort();
                }
                
                // Guardar en localStorage
                saveToStorage();
            }
        }

        // Función para guardar datos en localStorage
        function saveToStorage() {
            try {
                localStorage.setItem('sorteo_nombres', JSON.stringify(names));
                localStorage.setItem('sorteo_eliminar_ganador', eliminarGanadorCheck.checked);
                localStorage.setItem('sorteo_version', APP_VERSION);
            } catch (e) {
                console.log('Error guardando datos:', e);
            }
        }

        // Función para cargar datos desde localStorage
        function loadFromStorage() {
            try {
                const savedNames = localStorage.getItem('sorteo_nombres');
                const savedEliminar = localStorage.getItem('sorteo_eliminar_ganador');
                const savedVersion = localStorage.getItem('sorteo_version');
                
                if (savedNames) {
                    names = JSON.parse(savedNames);
                    sortNamesAlphabetically();
                    renderList();
                }
                
                if (savedEliminar) {
                    eliminarGanadorCheck.checked = savedEliminar === 'true';
                }
                
                // Si hay una versión anterior, podemos hacer migraciones aquí
                if (savedVersion && savedVersion !== APP_VERSION) {
                    console.log(`Actualizando de versión ${savedVersion} a ${APP_VERSION}`);
                }
            } catch (e) {
                console.log('Error cargando datos:', e);
            }
        }

        // Función para Exportar Lista
        function exportList(type) {
            if (names.length === 0) {
                showNotification('La lista está vacía. Añade nombres antes de exportar.', 'warning');
                return;
            }

            let content = '';
            let mimeType = '';
            let extension = '';

            if (type === 'json') {
                content = JSON.stringify(names, null, 2);
                mimeType = 'application/json';
                extension = 'json';
            } else {
                // TXT (separado por comas para que sea compatible con la importación)
                content = names.join(',');
                mimeType = 'text/plain';
                extension = 'txt';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            // Crear enlace temporal y forzar descarga
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `lista_sorteo_${date}.${extension}`;
            document.body.appendChild(a);
            a.click();
            
            // Limpieza
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mostrar notificación
            showNotification(`Lista exportada correctamente (${names.length} nombres)`, 'success');
        }

        // Función para manejar la subida de archivos
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileName = file.name.toLowerCase();

            reader.onload = function(e) {
                const data = e.target.result;
                let importedNames = [];

                try {
                    if (fileName.endsWith('.json')) {
                        // Lógica JSON
                        const json = JSON.parse(data);
                        if (Array.isArray(json)) {
                            // Asumimos array de strings ["Juan", "Ana"] o objetos [{name: "Juan"}]
                            importedNames = json.map(item => {
                                if (typeof item === 'object' && item !== null) {
                                    return Object.values(item)[0]; // Toma el primer valor del objeto
                                }
                                return item;
                            });
                        } else {
                            showNotification('El archivo JSON debe contener una lista (array).', 'warning');
                            return;
                        }

                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Lógica Excel (SheetJS)
                        const workbook = XLSX.read(data, {type: 'binary'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        // Convertir a array de arrays
                        const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        // Aplanar array y filtrar
                        importedNames = rows.flat();

                    } else {
                        // Lógica TXT / CSV (separado por comas o saltos de línea)
                        // Reemplazamos saltos de línea por comas para unificar el split
                        const textContent = data.replace(/(\r\n|\n|\r)/gm, ",");
                        importedNames = textContent.split(',');
                    }

                    // Limpieza final de los datos importados
                    importedNames = importedNames
                        .map(n => String(n).trim()) // Convertir a string y quitar espacios
                        .filter(n => n.length > 0); // Quitar vacíos

                    // Filtrar duplicados antes de agregar
                    const uniqueImportedNames = importedNames.filter(name => !isDuplicate(name));
                    
                    // Si hay duplicados, informar al usuario
                    if (uniqueImportedNames.length < importedNames.length) {
                        const duplicateCount = importedNames.length - uniqueImportedNames.length;
                        showNotification(
                            `Se importaron ${uniqueImportedNames.length} nombres. Se omitieron ${duplicateCount} duplicados.`,
                            'info'
                        );
                    }

                    if (uniqueImportedNames.length > 0) {
                        addNamesToList(uniqueImportedNames);
                        showNotification(`¡Se importaron ${uniqueImportedNames.length} nombres correctamente!`, 'success');
                    } else {
                        showNotification('No se encontraron nombres válidos en el archivo.', 'warning');
                    }

                } catch (error) {
                    console.error(error);
                    showNotification('Error al leer el archivo. Asegúrate de que el formato sea correcto.', 'danger');
                }
                
                // Limpiar input para permitir subir el mismo archivo de nuevo si es necesario
                fileInput.value = ''; 
            };

            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }

        // Función para borrar un nombre específico
        function removeName(index) {
            names.splice(index, 1);
            
            // Ordenar alfabéticamente después de eliminar
            sortNamesAlphabetically();
            
            renderList();
            saveToStorage();
            
            if (!resultSection.classList.contains('d-none')) {
                resetSort();
            }
        }

        // Función para borrar toda la lista
        function clearList() {
            if(confirm('¿Estás seguro de que quieres borrar toda la lista?')) {
                names = [];
                renderList();
                resetSort();
                saveToStorage();
            }
        }

        // Renderizar la lista de entrada
        function renderList() {
            nameList.innerHTML = '';
            countSpan.textContent = names.length;

            if (names.length === 0) {
                nameList.appendChild(emptyState);
                sortBtn.disabled = true;
                clearBtn.classList.add('d-none');
            } else {
                sortBtn.disabled = names.length < 2; 
                clearBtn.classList.remove('d-none');

                names.forEach((name, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div class="d-flex align-items-center overflow-hidden">
                            <span class="badge bg-primary rounded-circle me-3" style="width: 28px; height: 28px; line-height: 28px;">${index + 1}</span>
                            <span class="fw-medium text-truncate">${escapeHtml(name)}</span>
                        </div>
                        <button onclick="removeName(${index})" class="btn btn-link text-muted p-0">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    nameList.appendChild(li);
                });
            }
        }

        // Función Principal: Ordenar Aleatoriamente (Algoritmo Fisher-Yates)
        function sortNames() {
            if (names.length < 2) return;

            let shuffled = [...names];
            
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            renderResults(shuffled);
            launchConfetti();
            
            // Si está activada la opción de eliminar ganador, eliminar el primer lugar
            if (eliminarGanadorCheck.checked && shuffled.length > 0) {
                const winner = shuffled[0];
                const indexToRemove = names.findIndex(name => 
                    name.toLowerCase().trim() === winner.toLowerCase().trim()
                );
                
                if (indexToRemove !== -1) {
                    names.splice(indexToRemove, 1);
                    
                    // Ordenar alfabéticamente después de eliminar
                    sortNamesAlphabetically();
                    
                    renderList();
                    saveToStorage();
                    
                    // Mostrar notificación que desaparece automáticamente después de 5 segundos
                    setTimeout(() => {
                        showNotification(`El ganador "${winner}" ha sido eliminado de la lista.`, 'info');
                    }, 500);
                }
            }
        }

        // Mostrar resultados
        function renderResults(sortedNames) {
            resultList.innerHTML = '';
            resultSection.classList.remove('d-none');
            
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            sortedNames.forEach((name, index) => {
                let isWinner = index === 0;
                
                const li = document.createElement('li');
                li.className = `result-item p-3 rounded list-item-enter ${isWinner ? 'winner-item' : ''}`;
                li.style.animationDelay = `${index * 0.1}s`;
                
                li.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="badge ${isWinner ? 'winner-badge' : 'bg-secondary'} rounded-circle me-3 d-flex align-items-center justify-content-center" 
                              style="width: 40px; height: 40px; font-size: 1.1rem;">
                            ${index + 1}
                        </span>
                        <div class="flex-grow-1">
                            <h5 class="mb-0 ${isWinner ? 'fw-bold text-warning' : 'fw-normal'}">
                                ${escapeHtml(name)} ${isWinner ? '<i class="fa-solid fa-crown ms-2"></i>' : ''}
                            </h5>
                            <small class="text-muted">Posición ${index + 1}</small>
                        </div>
                    </div>
                `;
                resultList.appendChild(li);
            });
        }

        function resetSort() {
            resultSection.classList.add('d-none');
            resultList.innerHTML = '';
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function launchConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function(min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // Función para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'warning': 'alert-warning',
                'danger': 'alert-danger',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const icon = {
                'success': 'fa-circle-check',
                'warning': 'fa-triangle-exclamation',
                'danger': 'fa-circle-exclamation',
                'info': 'fa-circle-info'
            }[type] || 'fa-circle-info';

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} auto-dismiss-alert mt-3`;
            alertDiv.innerHTML = `
                <i class="fa-solid ${icon} me-2"></i>
                ${message}
            `;
            
            const container = document.querySelector('#listsContainer');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Eliminar la alerta después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // --- Funcionalidades PWA ---

        // Mostrar instrucciones de instalación
        function showInstallInstructions() {
            const modal = new bootstrap.Modal(document.getElementById('installModal'));
            modal.show();
        }

        // Instalar PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario aceptó la instalación');
                        showNotification('¡Aplicación instalada correctamente!', 'success');
                        installButton.classList.add('d-none');
                        deferredInstallBtn.classList.add('d-none');
                    } else {
                        console.log('Usuario rechazó la instalación');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Detectar cambios en la conexión
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            if (isOnline) {
                offlineIndicator.classList.remove('show');
                appStatus.innerHTML = '<i class="fa-solid fa-circle me-1" style="font-size: 0.6rem;"></i> Online';
                appStatus.className = 'badge bg-success bg-opacity-75';
            } else {
                offlineIndicator.classList.add('show');
                appStatus.innerHTML = '<i class="fa-solid fa-circle me-1" style="font-size: 0.6rem;"></i> Offline';
                appStatus.className = 'badge bg-danger bg-opacity-75';
            }
        }

        // Registrar Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registrado con éxito:', registration.scope);
                            
                            // Verificar actualizaciones
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('¡Nueva versión disponible! Recarga la página para actualizar.', 'info');
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.log('Error al registrar ServiceWorker:', error);
                        });
                });
            }
        }

        // Inicializar la aplicación
        function initApp() {
            // Cargar datos guardados
            loadFromStorage();
            
            // Configurar eventos de conexión
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
            
            // Registrar Service Worker
            registerServiceWorker();
            
            // Evento para instalación de PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar botón de instalación si no está ya instalado
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    installButton.classList.remove('d-none');
                    deferredInstallBtn.classList.remove('d-none');
                }
            });
            
            // Ocultar botón de instalación si ya está instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
                installButton.classList.add('d-none');
            }
            
            // Evento cuando la app se instala
            window.addEventListener('appinstalled', () => {
                console.log('Aplicación instalada');
                installButton.classList.add('d-none');
                deferredInstallBtn.classList.add('d-none');
                deferredPrompt = null;
            });
            
            // Guardar automáticamente cuando cambia el checkbox
            eliminarGanadorCheck.addEventListener('change', saveToStorage);
        }

        // Inicializar cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>